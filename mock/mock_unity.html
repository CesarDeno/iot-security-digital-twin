<!DOCTYPE html>
<html lang="es">
   <head>
      <meta charset="UTF-8" />
      <title>Panel de Seguridad (Cliente MQTT Directo)</title>
      <!-- Librer√≠a Paho MQTT para conectar JS con Mosquitto -->
      <script
         src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
         type="text/javascript"
      ></script>
      <style>
         body {
            font-family: "Segoe UI", sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
         }
         .dashboard {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
         }
         .card {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
         }
         h2 {
            margin: 0 0 15px 0;
            font-size: 1.2em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
         }
         .status-icon {
            font-size: 4em;
            margin: 10px 0;
            transition: all 0.3s ease;
         }
         .status-text {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
         }
         .meta-info {
            font-size: 0.9em;
            color: #aaa;
            background: #333;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
         }

         .open {
            color: #ff4444;
         }
         .closed {
            color: #00c851;
         }
         .denied {
            color: #ffbb33;
            animation: shake 0.5s;
         } /* Nuevo estilo para denegado */

         @keyframes shake {
            0% {
               transform: translate(1px, 1px) rotate(0deg);
            }
            10% {
               transform: translate(-1px, -2px) rotate(-1deg);
            }
            20% {
               transform: translate(-3px, 0px) rotate(1deg);
            }
            30% {
               transform: translate(3px, 2px) rotate(0deg);
            }
            40% {
               transform: translate(1px, -1px) rotate(1deg);
            }
            50% {
               transform: translate(-1px, 2px) rotate(-1deg);
            }
            60% {
               transform: translate(-3px, 1px) rotate(0deg);
            }
            70% {
               transform: translate(3px, 1px) rotate(-1deg);
            }
            80% {
               transform: translate(-1px, -1px) rotate(1deg);
            }
            90% {
               transform: translate(1px, 2px) rotate(0deg);
            }
            100% {
               transform: translate(1px, -2px) rotate(-1deg);
            }
         }

         .log-container {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            border: 1px solid #333;
         }
         .log-entry {
            border-bottom: 1px solid #222;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
         }
         .log-time {
            color: #666;
            margin-right: 10px;
         }
         .log-msg {
            color: #ddd;
         }
         .denied-log {
            color: #ffbb33;
            font-weight: bold;
         } /* Log rojo/naranja */

         button {
            padding: 12px 24px;
            cursor: pointer;
            background: #33b5e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background 0.2s;
         }
         button:hover {
            background: #0099cc;
         }
         .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 10px;
            display: inline-block;
         }
         .connected {
            background: #00c851;
            color: white;
         }
         .disconnected {
            background: #ff4444;
            color: white;
         }
      </style>
   </head>
   <body>
      <h1>üõ°Ô∏è Sistema de Control (MQTT Directo)</h1>

      <div id="connectionStatus" class="status-badge disconnected">Desconectado</div>

      <div class="dashboard">
         <div class="card">
            <h2>Estado de Puerta</h2>
            <div id="icon" class="status-icon closed">üîí</div>
            <div id="statusText" class="status-text closed">CERRADO</div>
            <div class="meta-info">ID: <span id="devId">--</span></div>
         </div>
         <div class="card">
            <h2>√öltimo Evento</h2>
            <div style="font-size: 3em; margin: 10px 0">üîë</div>
            <div id="method" class="status-text" style="color: #bbb">--</div>
            <div class="meta-info">Resultado Acceso</div>
         </div>
      </div>

      <div
         class="card"
         style="
            width: 600px;
            margin-bottom: 20px;
            flex-direction: row;
            display: flex;
            justify-content: space-around;
            align-items: center;
         "
      >
         <h2>Acciones Remotas</h2>
         <button onclick="publishCommand('FORCE_LOCK')">üîí Bloquear</button>
         <button onclick="publishCommand('FORCE_UNLOCK')" style="background: #ff4444">üîì Desbloquear</button>
      </div>

      <h3>Log MQTT en Tiempo Real</h3>
      <div id="log" class="log-container"></div>

      <script>
         // CONFIGURACI√ìN MQTT
         const BROKER = "127.0.0.1";
         const PORT = 9001; // Puerto WebSockets de Mosquitto
         const TOPIC_TELEMETRY = "iot/telemetry";
         const TOPIC_COMMANDS = "iot/commands";

         const clientID = "unity_mock_" + Math.random().toString(16).substr(2, 8);
         const client = new Paho.MQTT.Client(BROKER, PORT, clientID);

         // UI Elements
         const logDiv = document.getElementById("log");
         const uiIcon = document.getElementById("icon");
         const uiText = document.getElementById("statusText");
         const uiMethod = document.getElementById("method");
         const uiDevId = document.getElementById("devId");
         const connStatus = document.getElementById("connectionStatus");

         // Callbacks
         client.onConnectionLost = onConnectionLost;
         client.onMessageArrived = onMessageArrived;

         // Conectar
         log("Intentando conectar a MQTT Broker...");
         client.connect({
            onSuccess: onConnect,
            onFailure: onFailure,
            keepAliveInterval: 30,
         });

         function onConnect() {
            log("‚úÖ Conectado a Mosquitto (Port 9001)");
            connStatus.innerText = "Conectado MQTT";
            connStatus.className = "status-badge connected";
            client.subscribe(TOPIC_TELEMETRY);
         }

         function onFailure(responseObject) {
            log("‚ùå Fallo conexi√≥n: " + responseObject.errorMessage);
            connStatus.innerText = "Error Conexi√≥n";
         }

         function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
               log("‚ö†Ô∏è Conexi√≥n perdida: " + responseObject.errorMessage);
               connStatus.innerText = "Desconectado";
               connStatus.className = "status-badge disconnected";
            }
         }

         function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;

            if (topic === TOPIC_TELEMETRY) {
               const data = JSON.parse(payload);
               updateDashboard(data);

               // Logging inteligente seg√∫n el resultado
               if (data.access_granted === false) {
                  logHtml(`<span class="denied-log">‚ö†Ô∏è ACCESO DENEGADO [${data.access_method}]</span>`);
               } else if (data.door_status === "OPEN") {
                  log(`üîì PUERTA ABIERTA (${data.access_method})`);
               } else {
                  log(`üîí Puerta cerrada`);
               }
            }
         }

         function publishCommand(action) {
            if (client.isConnected()) {
               const payload = JSON.stringify({ action: action });
               message = new Paho.MQTT.Message(payload);
               message.destinationName = TOPIC_COMMANDS;
               client.send(message);
               log(`üì§ [CMD] Enviado: ${action}`);
            } else {
               log("‚ö†Ô∏è No se puede enviar: Cliente desconectado");
            }
         }

         function updateDashboard(data) {
            uiDevId.innerText = data.device_id;

            // L√≥gica visual basada en access_granted
            if (data.access_granted === false) {
               // Caso: Acceso Denegado
               uiIcon.innerText = "üö´";
               uiIcon.className = "status-icon denied";
               uiText.innerText = "DENEGADO";
               uiText.className = "status-text denied";
               uiMethod.innerText = data.access_method || "Intento Fallido";
               uiMethod.style.color = "#ffbb33";
            } else if (data.door_status === "OPEN") {
               // Caso: Puerta Abierta
               uiIcon.innerText = "üîì";
               uiIcon.className = "status-icon open";
               uiText.innerText = "ABIERTO";
               uiText.className = "status-text open";
               uiMethod.innerText = "Autorizado: " + (data.access_method || "Manual");
               uiMethod.style.color = "#00C851";
            } else {
               // Caso: Puerta Cerrada
               uiIcon.innerText = "üîí";
               uiIcon.className = "status-icon closed";
               uiText.innerText = "CERRADO";
               uiText.className = "status-text closed";
               uiMethod.innerText = "Esperando...";
               uiMethod.style.color = "#666";
            }
         }

         function log(text) {
            logHtml(`<span class="log-msg">${text}</span>`);
         }

         function logHtml(htmlContent) {
            const div = document.createElement("div");
            div.className = "log-entry";
            div.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString()}</span>${htmlContent}`;
            logDiv.prepend(div);
         }
      </script>
   </body>
</html>
